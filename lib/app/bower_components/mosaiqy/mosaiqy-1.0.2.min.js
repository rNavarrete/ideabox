/**
* Mosaiqy 1.0.2 for jQuery 1.9+
* @author Fabrizio Calderan, http://www.fabriziocalderan.it/mosaiqy
* Released under license Creative Commons, Attribution-NoDerivs 3.0
* (CC BY-ND 3.0) available at http://creativecommons.org/licenses/by-nd/3.0/
* Read the license carefully before using this plugin. Do not remove this comment.
*/
(function(f){f.sub=function(){function b(a,e){return new b.fn.init(a,e)}jQuery.extend(!0,b,this);b.superclass=this;b.fn=b.prototype=this();b.fn.constructor=b;b.sub=this.sub;b.fn.init=function(k,e){e&&(e instanceof jQuery&&!(e instanceof b))&&(e=b(e));return jQuery.fn.init.call(this,k,e,a)};b.fn.init.prototype=b.fn;var a=b(document);return b};var v=function(){var b=document.createElement("div");return{isEnabled:"transition"in b.style||"MsTransition"in b.style||"OTransition"in b.style||"MozTransition"in b.style||"WebkitTransition"in b.style,transitionEnd:"oTransitionEnd webkitTransitionEnd transitionend"}}(),C=function(b){var a,k,e,c=[];for(a=0;a<b;a++)c[a]=a;for(;--b;)a=~~(Math.random()*(b+1)),k=c[b],e=c[a],c[b]=e,c[a]=k;return c},x=function(b){var a={animationDelay:3E3,animationSpeed:800,avoidDuplicates:!1,cols:2,fadeSpeed:750,indexData:0,loadTimeout:7500,loop:!0,onCloseZoom:null,onOpenZoom:null,openZoom:!0,rows:2,scrollZoom:!0,template:""},k,e,c,f,l=[],t=[],h={},n=!1,s=!1,q,p,r=b("html:not(:animated), body:not(:animated)"), v=function(m){var d="";"undefined"===typeof h[m]&&(h[m]=a.template.replace(/\$\{([^\}]+)\}/gm,function(b,d){var g;g=d.split(".");var c=0,e;if(g.length){e=a.data[m];g=g.reverse();for(c=g.length;c--;)e=e[g[c]]||{};g="string"===typeof e?e:""}else g=a.data[m][d];return"undefined"===typeof g?d:g}));d=h[m];"function"===typeof window.innerShiv&&(d=window.innerShiv(d,!1));return b(d)},x=function(){var m=c.eq(0);q=m.outerWidth(!0);p=m.outerHeight(!0);c.each(function(d,c){b(c).css({top:p*~~(d/a.cols),left:q* (d%a.cols)})});e.css({minHeight:p*a.rows,width:q*a.cols});k.css({minHeight:p*a.rows,width:q*a.cols})},D=function(){var b,d,c;for(d=0;d<a.cols;d+=1)c="li:nth-child($0n+$1)".replace(/\$(\d)/g,function(b,c){return[a.cols,d+1][c]}),l.push({prop:"top",selector:c,node:d,position:{top:-p,left:q*d}}),l.push({prop:"top",selector:c,node:a.cols*(a.rows-1)+d,position:{top:p*a.rows,left:q*d}});for(d=b=0;d<a.rows;d+=1)c="li:nth-child(n+$0):nth-child(-n+$1)".replace(/\$(\d)/g,function(c,d){return[b+1,b+a.cols][d]}), l.push({prop:"left",selector:c,node:b,position:{top:p*d,left:-q}}),l.push({prop:"left",selector:c,node:b+=a.cols,position:{top:p*d,left:q*a.cols}});l[l.length-1].node-=1},E=function(){var m,d,f,u,g,n=b.Deferred();m=t.pop();g=0===(m&1);u=k.find(l[m].selector);d=c.eq(l[m].node);f=m<l.length-1?b("<li />").insertBefore(d):b("<li />").insertAfter(d);f.data("mosaiqy-index",a.indexData);v(a.indexData).appendTo(f.css(l[m].position));b.when(f.find("img").mosaiqyImagesLoad(a.loadTimeout)).fail(function(){f.remove(); n.reject()}).done(function(){var d=l[m].prop,t="left"===d?q:p,h=u.add(f),s=h.length,r={};r[d]="+="+(g?t:-t)+"px";h.animate(r,a.animationSpeed,function(){var m;--s||(g?u.last().remove():u.first().remove(),u=g?u.slice(0,u.length-1):u.slice(1,u.length),"top"===d&&(m=u.length,u.each(function(d){var f,y;c=k.find("li:not(.mosaiqy-zoom)");f=b(this);y=c.index(f);if(d=g?a.cols:-(a.cols-(1===m-d?0:1)))y+=d,y<c.length?f.insertBefore(c.eq(y)):f.appendTo(e)})),n.resolve())})});return n.promise()},w=function(){n|| s?setTimeout(function(){w()},2*a.animationDelay):(s=!0,0===t.length&&(t=C(l.length)),F(),b.when(E()).then(function(){a.indexData+=1;s=!1}).fail(function(){w()}).done(function(){c=e.find("li:not(.mosaiqy-zoom)");setTimeout(function(){w()},a.animationDelay)}))},F=function(){var e=a.data.length,d=[];if(a.indexData===a.data.length)if(a.loop)a.indexData=0;else{n=!0;return}if(a.avoidDuplicates)for(c.each(function(){var a=b(this).data("mosaiqy-index");d[a]=a});e--;)if("undefined"!==typeof d[a.indexData]){if(a.indexData+= 1,a.indexData===a.data.length)if(a.loop)a.indexData=0;else{n=!0;break}}else break},G=function(f){function d(){var d=b.Deferred();(g||{}).length?(v.stop(!0)._animate({opacity:"0"},a.fadeSpeed/4),w.stop(!0)._animate({opacity:"0"},a.fadeSpeed/2),c.removeClass("zoom"),b.when(g.stop(!0)._animate({height:"0"},a.fadeSpeed)).then(function(){g.remove();g=null;if("function"===typeof a.onCloseZoom)a.onCloseZoom(h);d.resolve()})):d.resolve();return d.promise()}function l(){var c,e,f;A=g.find("figure");v=g.find("figcaption"); c=b('<img class="mosaiqy-zoom-image" />').attr({src:h.find("a").attr("href")});c.appendTo(A);0===c.get(0).height&&c.hide();f=c.get(0).complete?c.height():200;g._animate({height:f+"px"},a.fadeSpeed,function(){if("function"===typeof a.onOpenZoom)a.onOpenZoom(h)});(e=h.find("img").prop("longDesc"))&&c.wrap(b("<a />").attr({href:e,target:"new"}));w=b('<a class="mosaiqy-zoom-close">Close</a>').attr({href:"#"}).on("click.mosaiqy",function(a){b.when(d()).then(function(){k.removeClass("zoom");n=p=!1});a.preventDefault()}).appendTo(A); b.when(c.mosaiqyImagesLoad(a.loadTimeout,function(b){setTimeout(function(){var d=c.get(0).height?a.fadeSpeed:0;b.fadeIn(d,function(){w._animate({opacity:"1"},a.fadeSpeed/2);v.html(h.find("figcaption").html())._animate({opacity:"1"},a.fadeSpeed)})},a.fadeSpeed/1.2)})).done(function(){f<c.height()&&g._animate({height:c.height()+"px"},a.fadeSpeed)}).fail(function(){w.trigger("click.mosaiqy")})}function t(d){p=!0;b.when(d()).done(function(){var d;k.addClass("zoom");h.addClass("zoom");c=k.find("li:not(.mosaiqy-zoom)"); z=h.offset().top;x=0!==document.body.scrollTop?document.body.scrollTop:document.documentElement.scrollTop;a.scrollZoom?(B=Math.abs(x-z),d=0<B?1.5*B+400:0):(z=x,d=0);g='<li class="mosaiqy-zoom"><figure><figcaption></figcaption></figure></li>';g="function"===typeof window.innerShiv?b(innerShiv(g,!1)):b(g);q<c.length?g.insertBefore(c.eq(q)):g.appendTo(e);b.when(r.stop()._animate({scrollTop:z},d)).done(function(){p=!1;l()})})}var g,h,q,p,A,v,w,x,z,B;f.on("click.mosaiqy","li:not(.mosaiqy-zoom)",function(e){s|| p?e.preventDefault():(n=!0,h=b(this),q=a.cols*Math.ceil((c.index(h)+1)/a.cols),a.openZoom&&!h.hasClass("zoom")&&(e.preventDefault(),t(d)))})},H=function(c){for(var d;c--;)d=v(a.indexData),d.appendTo(b("<li />").appendTo(e)),a.indexData+=1};return{init:function(h,d){var l=0;a=b.extend(a,d);if(!(a.data||[]).length)throw Error("Data object is empty");if(a.template&&b("#"+a.template).is("script"))a.template=b("#"+a.template).text()||b("#"+a.template).html(),a.template=a.template.replace(/^\s+|\s+$/,""); else throw Error("User template is not defined");k=h;e=h.find("ul");c=h.find("li:not(.mosaiqy-zoom)");if(l=a.cols*a.rows-c.length)if(a.data.length>=l)a.indexData=c.length,H(l),c=h.find("li:not(.mosaiqy-zoom)");else throw Error("Mosaiqy can't find missing images on JSON data.");a.avoidDuplicates&&c.each(function(a){"undefined"===typeof b(this).data("mosaiqy-index")&&b(this).data("mosaiqy-index",a)});f=h.find("img");x();D();k.delegate("ul","mouseenter.mosaiqy",function(){n=!0}).delegate("ul","mouseleave.mosaiqy", function(){k.hasClass("zoom")||(n=!1)});b.when(f.mosaiqyImagesLoad(a.loadTimeout,function(b){b.animate({opacity:"1"},a.fadeSpeed)})).done(function(){k.removeClass("loading");G(e);setTimeout(function(){w()},a.animationDelay)}).fail(function(){return!1});return this}}},r=f.sub();r.fn.mosaiqyImagesLoad=function(b,a){var k=f.Deferred(),e=this.length,c=[],r=[],l=b||8419.78;e&&this.each(function(){var b=this;f.when(function(){var a=f.Deferred(),c=setTimeout(function(){f(b).trigger("error.mosaiqy")},l); f(b).one("load.mosaiqy",function(){clearInterval(c);a.resolve()}).on("error.mosaiqy",function(){clearInterval(c);a.reject()}).attr("src",b.src);b.complete&&setTimeout(function(){f(b).trigger("load.mosaiqy")},10);return a.promise()}()).done(function(){c.push(b.src);a&&a(f(b))}).fail(function(){r.push(b.src)}).always(function(){e-=1;0===e&&(r.length?k.reject():k.resolve())})});return k.promise()};r.fn.extend({_animate:f.fn.animate,animate:function(b,a,k,e){var c=a&&"object"===typeof a?f.extend({},a): {duration:a,complete:e||!e&&k||f.isFunction(a)&&a,easing:e&&k||k&&!f.isFunction(k)&&k};return f(this).each(function(){var e=r(this),k=e.position(),t={},h=a/1E3+"s",n;if(v.isEnabled){if("object"===typeof b)for(var s in b)("left"===s||"top"===s)&&(n=b[s].match(/^(?:\+|\-)=(\-?\d+)/))&&n.length&&(t[s]=k[s]+parseInt(n[1],10));e.on(v.transitionEnd,function(){f.isFunction(c.complete)&&c.complete()}).css(t).css({"-webkit-transition-duration":h,"-moz-transition-duration":h,"-ms-transition-duration":h,"-o-transition-duration":h, "transition-duration":h})}else e._animate(b,c)})}});f.fn.mosaiqy=function(b){if(this.length)return this.each(function(){var a=new x(r);a.init(r(this),b);f.data(this,"mosaiqy",a)})}})(jQuery);